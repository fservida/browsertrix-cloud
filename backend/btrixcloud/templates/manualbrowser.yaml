---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: manualbrowser-{{ id }}
  namespace: {{ namespace }}
  labels:
    manualbrowser: {{ id }}
    role: manualbrowser

spec:
  selector:
    matchLabels:
      manualbrowser: {{ id }}
      role: manualbrowser

  serviceName: manualbrowser-{{ id }}
  replicas: 1

  template:
    metadata:
      labels:
        manualbrowser: {{ id }}
        role: manualbrowser

    spec:
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 1
              preference:
                matchExpressions:
                - key: nodeType
                  operator: In
                  values:
                    - "{{ crawler_node_type }}"

        podAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 2
              podAffinityTerm:
                topologyKey: "failure-domain.beta.kubernetes.io/zone"
                labelSelector:
                  matchLabels:
                    job: job-{{ id }}
                    crawl: {{ id }}

      tolerations:
        - key: "nodeType"
          operator: "Equal"
          value: "crawling"
          effect: "NoSchedule"

      containers:
        - name: browser
          image: {{ crawler_image }}
          imagePullPolicy: {{ crawler_image_pull_policy }}
          command:
            - create-login-profile
            - --interactive
            - --filename
            - /tmp/manual.wacz
            - --url
            - {{ url }}

          envFrom:
            - secretRef:
                name: storage-{{ storage_name }}

          env:
            - name: STORE_PATH
              value: {{ storage_path }}

            - name: VNC_PASS
              value: {{ vnc_password }}

---
apiVersion: v1
kind: Service
metadata:
  name: manualbrowser-{{ id }}
  labels:
    manualbrowser: {{ id }}
    role: manualbrowser
 
spec:
  clusterIP: None
  selector:
    manualbrowser: {{ id }}
    role: manualbrowser

  ports:
    - protocol: TCP
      port: 9223
      name: browser-api

    - protocol: TCP
      port: 9222
      name: browser-ws

